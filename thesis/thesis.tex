%\documentclass[12pt, a4paper, parskip=half, headings=small, draft=true]{scrartcl} % [10pt, twocolumn] (Schnellübersicht goo.gl/AS72B)
\documentclass[10pt, a4paper]{scrartcl} % Std 11pt % 10 pt!!!
\usepackage[T1]{fontenc} % Umlaute
\usepackage[utf8]{inputenc} % Textcodierung
\usepackage[english]{babel} % Silbentrennung
%\usepackage{marvosym, amsmath, amssymb} % Symbole, Formeln, amssymb > mathdesign
\usepackage{lmodern, microtype} % enhanced CM, mikrotypograﬁsche Feinheiten
\usepackage[in]{fullpage} % Ränder [in|cm]
%\usepackage{graphicx, listings} % Grafiken, Quelltext
\usepackage[hidelinks]{hyperref} % Hyperlinks
%\usepackage[dvipsnames]{xcolor} % Farben (goo.gl/sP8iP, S.38)
%\usepackage[charter]{mathdesign} % Schriftart B. Charter
%\usepackage{mathptmx} % Schriftart Times
\usepackage{booktabs}

% ``quotation marks''

\usepackage[firstpage]{draftwatermark} % [final]
\SetWatermarkLightness{0.9}

\usepackage{csquotes} % Recommended addition for biblatex
\usepackage[style=numeric,backend=biber]{biblatex}
\addbibresource{thesis.bib}

\let\origunderscore\_
\renewcommand{\_}{\origunderscore\allowbreak}
\newcommand{\config}[1]{\texttt{config.\allowbreak #1}}

\begin{document}
\begin{titlepage}
\noindent
\begin{center}
\large{Lehrstuhl für IT-Sicherheitsinfrastrukturen, Informatik 1\\
Friedrich-Alexander-Universität Erlangen-Nürnberg}

\vspace{2cm}
\textbf{\Large{Bachelor Thesis}}

\vspace{1cm}
\textbf{\textsf{\huge{Analysis of BitTorrent Trackers and Peers}}}

\vspace{0.4cm}
\textbf{\textsf{\LARGE{Counting Confirmed Downloads in BitTorrent}}}

\vspace{1cm}
\Large{Stefan Schindler\footnote{Email: stefan@kaloix.de, Student number: 21676746}}

\vspace{1cm}
\Large{Erlangen, \today}

\vspace{6cm}
\large{Examiner: Prof. Dr.-Ing. Felix Freiling\\
Advisor: Philipp Klein, M. Sc.}

\vspace{2cm}
\large{This work is licensed under the\\
Creative Commons Attribution-ShareAlike 4.0 International License.\\
To view a copy of this license, visit\\
\url{http://creativecommons.org/licenses/by-sa/4.0/}.}
\end{center}
\end{titlepage}

\section*{Todo}
\begin{itemize}
  \item Describe code functionality or exact implementation or both?
\end{itemize}

\begin{itemize}
  \item Program tool
  \item Program evaluation and diagram output
  \item Perform main analysis
  \item Write thesis
  \item Grafik, Listings, Tabellen-Verzeichnis
  \item pymdht thesis; http://people.kth.se/~rauljc/p2p11/
\end{itemize}

\tableofcontents
\newpage

\section{Introduction}
[Some general information on the context and setting]

\begin{itemize}
  \item BitTorrent by Bram Cohen 2008, a decentral network
  \item BitTorrent traffic statistics
  \item Other file sharing technologies
\end{itemize}

\subsection{Motivation}
[Specific motivation for the problem at hand]

\begin{itemize}
  \item General statistics about illegal usage of BitTorrent
  \item Unique peers vs observed downloads as lower bound
  \item Gather statistics without up- or downloading content
\end{itemize}

\subsection{Task}
[Concrete task to be solved]

\begin{itemize}
  \item Tool: Evaluate one or multiple given torrents
  \item Tool: Count observed downloads per hour
  \item Tool: Determine download speeds of peers
  \item Tool: Group them after geographical territories using IP address geolocation
  \item Drawback: One can only derive lower bounds from observing peers using the standard BitTorrent protocol
  \item Drawback: There is no complete overview about all running torrents, we need to choose a subset
  \item Evaluation: Choose interesting torrents for analysis from different content categories
  \item Evaluation: Run analysis tool for several days or weeks
\end{itemize}

\subsection{Related Work}
[Other relevant academic work and how it differs from this work]

\begin{itemize}
  \item \cite{watters2011much}
  \item \cite{drachen2011distribution}
  \item \dots
\end{itemize}

\subsection{Results}
[What has been achieved in this work?]

\dots

\subsection{Outline}
[How is the thesis structured and why?]

\dots

\subsection{Acknowledgments}
[A big thank you for the support to ...]

\dots

\section{Background}
This chapter explaines technologies and specifications utilized during this research project.

\subsection{BitTorrent Protocol}
Besides several extensions, BitTorrent still works as designed by \textsc{Bram Cohen} in January 10, 2008, in the \emph{BitTorrent Enhancement Proposal} number 3, shortened BEP 3 \cite{bep3}. It establishes a method to distribute a predefined set of files amoung an arbitrary number of recipients without overwhelming load on a central entity. This is achived by splitting the file set in pieces and let peers send them to each other. Three main parts are defined to enable the process: The BitTorrent file format containing identifying metadata about the file set, the communication procedure with a tracker server where peers can learn internet protocol addresses of other peers, and the peer wire protocol spoken between peers.

\subsubsection{Bencoding}
In order to store common data structures as well as transmit them over TCP, encoding is required to preserve the data's type and semantic. To realize BitTorrent, \textsc{Cohen} came up with \emph{bencoding} to annotate data appropriately. Any integers and length information is encoded in base 10 ASCII format. All types but strings have specific beginning and ending delimiter characters. Basic supported datatypes are byte strings and integers, saved as \texttt{<length>:<string>} and \texttt{i<integer>e} respectively. Composite types include lists stored as \texttt{l<value1><value2>e} and dictionaries alike \texttt{d<key1><value1><key2><value2>e}. Note that only strings can be used as dictionary keys.

\subsubsection{Metainfo File}
Metadata about a downloadable file set is stored bencoded in a metainfo file, which uses the \texttt{.torrent} file name extension. The purposis is to locate the tracker server and describe all content pieces with cryptographic hashes. Data is arranged in dictionaries of the following structure:

\begin{description}
  \item[announce] Uniform resource locator of the tracker server, usually of the form \nolinkurl{http://<host>:<port>/announce}.
  \item[info] The info dictionary describing the torrent's pieces
  \begin{description}
    \item[name] Optional file or directory name
    \item[piece length] Number of bytes in each piece
    \item[pieces] Concatenation of raw SHA-1 hash values for all pieces
    \item[length] Only present if the torrent is a single file; file size in bytes; not used in this project at all
    \item[files] Only present if the torrent containes multiple files; list of dictionaries, one per file; not used in this project at all
    \begin{description}
      \item[length] File size in bytes
      \item[path] List of subdirectory names and filename representing a path
    \end{description}
  \end{description}
\end{description}

The number of pieces can be derived from the \texttt{pieces} key of the \texttt{info} dictionary by dividing it's length by 20, since a SHA-1 hash is 20 bytes.

\subsubsection{Tracker Server}
Traditional communication with the tracker server is done via the GET request method of the Hypertext Transfer Protocol. The request is sent with the following parameters, whereby keys and values must be quoted using percent-encoding \cite[§~2.1]{percent}.

\begin{description}
  \item[info\_hash] SHA-1 hash of the bencoded info dictionary from the metainfo file
  \item[peer\_id] String of 20 bytes self choosen by each peer; contains client software information by convention
  \item[ip] Optional parameter with the peer's own IP address
  \item[port] Port number this peer is listening on for connections from other peers; recommended ports are 6881 to 6889
  \item[uploaded] Amount of uploaded pieces so far
  \item[downloaded] Amount of downloaded pieces so far
  \item[left] Amount of pices left to download
  \item[event] Optional key about the circumstances of this request; is \texttt{started}, \texttt{completed} or \texttt{stopped}
  \item[compact] To save bandwidth, a compact list of peers can be requested according to BEP 23 \cite{bep23}; is \texttt{0} or \texttt{1}
\end{description}

The tracker's response message should contain a bencoded dictionary in the message body. Following keys are defined:

\begin{description}
  \item[failure reason] In case of failure, human-readable error message explaing why the request could not be fulfilled
  \item[interval] Suggested interval in seconds the client should wait between tracker requests
  \item[peers] List of dictionaries, one per peer
  \begin{description}
    \item[peer id] Self-selected ID
    \item[ip] IP address
    \item[port] Port number
  \end{description}

  In case of a compact peer list, this is a single byte string instead of a list of dictionaries. 6 bytes per peer are used containing 4 bytes for the IP address and 2 byte representing the port number.
\end{description}

Tracker servers are the only centralized infrastructure required by traditional BitTorrent. Hence it is advisable to reduce bandwith during tracker requests as much as possible. As BEP 23 demonstrates, using a custom protocol over UDP instead of HTTP over TCP can reduce traffic by 50\,\% \cite{bep15}.

\dots

\subsubsection{Peer Wire Protocol}
\dots

\subsection{DHT}

\noindent\hrulefill

\begin{itemize}
  \item How does BitTorrent work (BEP 3)
  \item How does DHT work (BEP 5)
  \item Basic legal details of uploading and downloading via BitTorrent
  \item Basic legal classification about the analysis tool of this thesis
\end{itemize}

\section{Implementation}
\subsection{Dependencies}
There are a few external dependencies, which are all free and open-source software. The \emph{BencodePy} project by \textsc{Eric Weast} \cite{bencodepy} provides an encoder and decoder for bencoding messages and values. The \emph{Object Relational Mapper} of \emph{SQLAlchemy} \cite{sqlalchemy} is used to store evaluation results in the \emph{SQLite} database format \cite{sqlite}. The \emph{GeoIP2 API} \cite{geoip2-api} is used to perform IP geolocation lookups in the \emph{GeoLite2 City Database} \cite{geolite2-db}. This database is provided by \textsc{MaxMind, Inc.} under the \emph{Creative Commons Attribution-ShareAlike 3.0 Unported License}. In order to run a dedicated DHT node, the tool \emph{pymdht} by \textsc{Raul Jimenez} \cite{pymdht} is used.

\subsection{Functionality}
To count confirmed downloads by peers of one or multiple given torrents over a time period, the \emph{BitTorrent Download Analyzer} was written in Python 3. Torrents and all configuration parameters have to be provided at start, as they cannot be changed later. The program stores results in a SQLite database and runs until manual termination. A configuration file with several variables named \texttt{config.py} is provided. For simplification these variables will be referred to with the prefix ``\texttt{config.}'' in the following, so \config{x} translates to variable \texttt{x} in the configuration file.

The main task is to count confirmed downloads by peers of a given torrent. A download is considered as confirmed, when a peer crosses a threshold of downloaded pieces as defined in \config{torrent\_complete\_threshold}. Thus there must be contact with a peer at least twice -- with the amount of downloaded pieces once below and once equal or above the threshold -- in order to be counted. To determine the download progress of as many peers as possible, two tasks have to be done: First, establish contact to peers from every possible source. Second, receive continuous and reliable information about the download progress of every peer.

\paragraph{Import Torrents}
Beforehand, the torrents to be analyzed must be imported. Since both magnet links and torrent files are supported, there are two major ways to do this: All torrent files must be placed in a common directory, specified by \config{input\_path}. They are detected by their \texttt{.torrent} file name extension. Following the specification of BitTorrent files \cite{bep3}, the announce URL, infohash, pieces count and pieces size are extracted.

All magnet links \cite{bep9} to be considered must be placed in a file defined by \config{magnet\_file}, one per line. Since magnet links do not contain the amount and size of the torrent's pieces, but only their infohash, this information must be retrieved from the swarm of other peers. A few peer adresses are gathered with a DHT lookup, then peers are contacted sequentially until the info dictionary could be received using the Extension Protocol \cite{bep10} and the \emph{ut\_metadata} extension \cite{bep9}. The metadata and source of each imported torrent is stored the database for later reference.

\paragraph{Contact Peers}
Sources for peer's IP addresses and port numbers include announce requests to the tracker server as well as lookups in the BitTorrent DHT network. Both are done in dedicated threads and periodically as defined by \config{tracker\_request\_interval} and \config{dht\_request\_interval}. The received peer addresses are filtered for duplicates and placed in a common queue. Each request procedure is recorded in the database with the number of received peers, duplicate peers and duration for further analysis.

Every peer in the queue has a timestamp assigned and must not be contacted prior to this time. When placed in the queue first, the timestamp is set to the current time. Peers in the queue are visited in parrallel, whereby the number of threads can be set in \config{peer\_evaluation\_threads}. The queue is sorted ascending, so if timestaps lie in the past the peer which is due the longest time is choosen, if timestamps lie in the future the thread will wait until the attached time is reached. For threads to be able to react to new peers, waiting is capped to \config{evaluator\_reaction}. When the limit is reached, the peer is put back in queue and another one will be choosen.

When a peer with permitted timestamp is picked, a TCP connection is established and the download progress evaluation initiated. Additionally, incoming connections from peers trying to download pieces are used to gather their download status. Therefore a TCP server is listening on the the port defined in \config{bittorrent\_listen\_port}. On successful download progress extraction results are written to the database and IP address port tuples are linked to their database ID in internal memory for later database updates. Failed contacts or peers with unknown infohashes are ignored.

\paragraph{Evaluate Download Progress}
Once a connection is established with a peer, it's download progress must be determined only using peer messages as defined by the BitTorrent Protocol \cite{bep3}. Since there is no dedicated request command for the number of available pieces, we depend on peer messages sent voluntary by the remote peer. Fortunately it is common to advertise available pieces right after the BitTorrent Protocol handshake with \texttt{bitfield} and \texttt{have} messages. These are stored for every peer contact in a seperate queue and processed by another thread. Messages are received until a timeout defined by \config{network\_timeout} hits, which is restarted after every message. Additionally there is a limit on the number of messages named \config{receive\_message\_max} to prevent infinite sessions.

Now the only possible approach to aquire the download progress is to compile a combined bitfield from these messages and count the present pieces. The number of total torrent pices from in the info dictionary helps validating the results.

\paragraph{Peer Database}
With reference to the peer's database identifier, the IP address and port number are saved in the internal memory in order to update an already stored peer entry in the database at later contact. Time and pieces count only of the first and the last peer contact are saved in the database, since this is enough to assess the transition of the confirmed downlaod's threshold. Additionally the download speed is calculated between each two consecutive contacts, whereby only an overall maximum is kept.

Other information about peers stored in the database include an anonymized IP address, the BitTorrent Protocol peer ID, top and second level domain of the hostname, IP geolocation with city, country and continent as determined by the \emph{GeoIP2 API} \cite{geoip2-api}, number of contacts and the original source of the peer's IP address. Afterwards the peer's queue timestamp is updated with the current time plus \config{peer\_revisit\_delay} and it is returned to the queue if \config{torrent\_complete\_threshold} is not reached.

\paragraph{Secundary Statistics}
In order to enable and proof validity of test results some statistics are logged at a certain interval defined in \config{statistic\_interval}. These are the length of the peer queue, length of the queue of visited peers, average workload of peer contact threads, mean time for receiving all messages before timeout. Cumulative values are unique incoming peers, successful initiated contacts, failed initiated contacts at first try, failed initiated contactsa at later try and successful evaluated incoming peers.

\dots

\hrulefill

\dots

Explain implementation of the features:

\begin{itemize}
\item Import torrents from \texttt{.torrent} files (BEP 3)
\item Import torrents form magnet links by fetching metadata via the \emph{ut\_metadata} extension (BEP 9) using the Extension Protocol (BEP 10)
\item Continuously get IPv4 peers from the tracker using HTTP (BEP 3) and UDP announce requests (BEP 15)
\item Communicate with peers using a subset of the Peer Wire Protocol (BEP 3)
\item Continuously get IPv4 peers by integrating a running DHT node (BEP 5) from the \emph{pymdht} project using local telnet
\item Actively contact collected peers and calculate minimum number of downloaded pieces by receiving all \emph{have} and \emph{bitfield} messages until a timeout
\item Passively listen for incoming peer connections and calculate minimum number of downloaded pieces analog
\item Save number of downloaded pieces from first and last visit and maximum download speed per peer in a SQLite database
\item Save city, country and continent via IP address geolocation
\item Save ISP by hostname and anonymized IP address
\item Analyze multiple torrents at once
\item Synchronized analysis shutdown process
\item Produce extensive log output
\item Save duplicate and timing statistics about peers received via DHT and tracker
\item Save statistics about failed and succeeded peer connections
\item Save workload statistics of active peer evaluation threads
\end{itemize}

\subsection{Architecture}
It is structured in the main script, an application module, five helper modules and an utility module, which will be described in detail.

They have the following roles:

\begin{description}
  \item[\texttt{main.py}] This is the main script to be invoked when performing the analysis.
  \item[\texttt{analyzer.py}]
  \item[\texttt{torrent.py}]
  \item[\texttt{tracker.py}]
  \item[\texttt{dht.py}]
  \item[\texttt{protocol.py}]
  \item[\texttt{storage.py}]
  \item[\texttt{util.py}]
  \item[\texttt{config.py}]
\end{description}

\subsection{Justification of Configuration Values}
\paragraph{\config{network\_timeout}}
The timeout for network operations is five seconds. It is used when asking the BitTorrent tracker or DHT node for peers and when asking other peers for metadata. These cases are uncritical as a failure is visible in the log files and did not happen during this research. The important spot of application is during the peer evaluation process. While all messages are received from a peer, the timeout resets after every message. The message collection is considered complete after the timeout finished without receiving a message.

To assess a reasonable timeout, the maximum used time between messages was recorded for every peer session. An average of these values was calculated and stored every five minutes, according to \config{statistic\_interval}. Only for this timeout estimation run \config{network\_timeout} was set to 30 seconds to achive most unbiased results. As can be seen in \cite{timeout-test}, five seconds are \_ times above the total average of \_ seconds.

INSERT MAXIMUM MESSAGE TIMEOUT AVERAGES HERE

\paragraph{\config{torrent\_complete\_threshold}}
\dots

\paragraph{\config{peer\_evaluation\_threads}}
\dots

\subsection{Restrictions}

Restrictions and why this does not invalidate the results (hopefully, TBD):

\begin{itemize}
  \item No support for IPv6 on HTTP, UDP or DHT requests
  \item No support for the Micro Transport Protocol ($\mu$TP)
  \item No support for Peer exchange (PeX)
  \item No support for the Tracker exchange extension (BEP 28)
  \item No support for the BitTorrent Local Tracker Discovery Protocol (BEP 22)
  \item No BitTrorrent Protocol support for getting download progress info
\end{itemize}

\subsection{Usage}
pymdht: It must me started seperately and is controlled automatically using a localhost Telnet connection. It could not be integrated directly, since it is written in Python version 2. The desired UDP node port and the Telnet control port must be given as arguments and should reflect the values written in the \emph{BitTorrent Download Analyzer's} configuration file. The typical command used here is \texttt{run\_pymdht\_node.py -{}-port=17000 -{}-telnet-port=17001}. It is sensible to check whether \emph{pymdht} has crashed before and after each analysis run to ensure complete results.

The main script, named \texttt{btda.py} can be controlled by using the following command line options.

\begin{description}
  \item[\texttt{-{}-active <threads>}] Actively contact and evaluate peers using the specified number of threads.
  \item[\texttt{-{}-passive}] Listen on the port specified in the configuration file for incoming connections and evaluate these peers.
  \item[\texttt{-{}-dht}] Integrate and control an already running \emph{pymdht} \cite{pymdht} DHT node using Telnet. The UDP port on which the node is running and the localhost Telnet port where \emph{pymdht} can be controlled are given via \config{dht\_node\_port} and \config{dht\_control\_port} respectively.
  \item[\texttt{-{}-debug}] Write log messages to the console instead of a file and include debug messages.
  \item[\texttt{-{}-help}] Show a help message and exit.
\end{description}

\section{Evaluation}
\subsection{Choosing Torrents}

\subsection{Confirmed Downloads}
Diagram: Timeline of confirmed downloads in 1 hour steps

Map: Distribution of downloads (TODO)

Map: Distribution of download speeds (TODO)

\subsection{Further Results}
Diagram: Timeline of new vs. duplicate received peers in 1 hour steps (TODO)

Table: Examine hostnames by ISP or seedbox provicers (TODO)

\section{Conclusion and Future Work}
\dots

\newpage

\printbibliography[heading=bibintoc]
\end{document}
